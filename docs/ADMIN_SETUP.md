# การตั้งค่าผู้ดูแลระบบ (Admin Setup)

## ขั้นตอนการตั้งค่า Admin

### 1. ตั้งค่าฐานข้อมูล
ตรวจสอบว่าไฟล์ `.env` มีการตั้งค่าฐานข้อมูลครบถ้วน:

```env
DB_HOST=localhost
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_NAME=your_db_name
DB_PORT=3306
```

### 2. อัปเดตฐานข้อมูล
ระบบจะอัปเดตฐานข้อมูลอัตโนมัติเมื่อเริ่มต้นแอปพลิเคชัน โดยจะเพิ่มคอลัมน์ `role` ในตาราง `employees`

### 3. สร้าง Admin User แรก

#### วิธีที่ 1: ใช้สคริปต์ create_admin.py
```bash
python create_admin.py
```

สคริปต์นี้จะ:
- ตรวจสอบการตั้งค่าฐานข้อมูล
- แสดงรายชื่อผู้ใช้ทั้งหมด
- อัปเดตสิทธิ์ผู้ใช้เป็น admin

#### วิธีที่ 2: อัปเดตในฐานข้อมูลโดยตรง
```sql
UPDATE employees 
SET role = 'admin' 
WHERE email = 'your-admin-email@go.buu.ac.th';
```

### 4. การเข้าถึงหน้า Admin

เมื่อผู้ใช้มีสิทธิ์ admin แล้ว จะสามารถเข้าถึง:

- **แดชบอร์ด Admin**: `/admin`
- **จัดการพนักงาน**: `/admin/employees`
- **รายละเอียดพนักงาน**: `/admin/employee/{id}`

## ฟีเจอร์ Admin

### แดชบอร์ด Admin (`/admin`)
- สถิติการลงเวลาโดยรวม
- จำนวนพนักงานทั้งหมด
- การเข้างานวันนี้
- บันทึกการลงเวลาล่าสุด

### จัดการพนักงาน (`/admin/employees`)
- ดูรายชื่อพนักงานทั้งหมด
- เปลี่ยนสิทธิ์ผู้ใช้ (employee ↔ admin)
- ดูข้อมูลพื้นฐานของพนักงาน

### รายละเอียดพนักงาน (`/admin/employee/{id}`)
- ข้อมูลส่วนตัวของพนักงาน
- สถิติการลงเวลา 30 วันล่าสุด
- ประวัติการลงเวลารายละเอียด
- เวลาเข้างานเฉลี่ย
- ชั่วโมงทำงานเฉลี่ย

## การจัดการสิทธิ์

### บทบาทในระบบ
- **employee**: พนักงานทั่วไป สามารถลงเวลาเข้า-ออกงานได้
- **admin**: ผู้ดูแลระบบ มีสิทธิ์เข้าถึงหน้า admin และจัดการผู้ใช้

### การเปลี่ยนสิทธิ์
1. เข้าสู่ระบบด้วยบัญชี admin
2. ไปที่หน้า "จัดการพนักงาน"
3. คลิกปุ่ม "เพิ่มสิทธิ์" หรือ "ลดสิทธิ์" ในการ์ดพนักงาน
4. ระบบจะอัปเดตสิทธิ์ทันที

### ข้อจำกัด
- Admin ไม่สามารถเปลี่ยนสิทธิ์ของตนเองได้
- ต้องมี admin อย่างน้อย 1 คนในระบบ

## การแก้ไขปัญหา

### ไม่สามารถเข้าถึงหน้า admin
1. ตรวจสอบว่าผู้ใช้มีสิทธิ์ admin ในฐานข้อมูล
2. ลองออกจากระบบและเข้าใหม่
3. ตรวจสอบ logs ของแอปพลิเคชัน

### ข้อผิดพลาดในการอัปเดตสิทธิ์
1. ตรวจสอบการเชื่อมต่อฐานข้อมูล
2. ตรวจสอบว่าผู้ใช้ที่จะอัปเดตมีอยู่ในระบบ
3. ตรวจสอบ CSRF token

### ฐานข้อมูลไม่อัปเดต
1. รันคำสั่ง migration ด้วยตนเอง:
```python
from database import migrate_database
migrate_database()
```

## การรักษาความปลอดภัย

- หน้า admin ได้รับการป้องกันด้วย decorator `@admin_required`
- การเปลี่ยนสิทธิ์ต้องผ่าน CSRF protection
- ข้อมูลผู้ใช้ได้รับการ sanitize ก่อนแสดงผล
- การเข้าถึงฐานข้อมูลผ่าน prepared statements

## การสำรองข้อมูล

แนะนำให้สำรองข้อมูลก่อนการเปลี่ยนแปลงสิทธิ์:

```bash
mysqldump -u username -p database_name > backup.sql
```